name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      DB_PASSWORD: ci
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: python -m pip install -r requirements.txt

      - name: Run tests
        run: python -m unittest discover tests -v

  deploy:
    needs: test
    runs-on: ubuntu-latest
    # Fails if EC2_SSH_KEY/EC2_HOST not set; workflow still green (tests passed)
    continue-on-error: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          printf "%s\n" "${{ secrets.EC2_SSH_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Copy project to EC2
        run: |
          ssh -i key.pem -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} "sudo rm -rf /home/ubuntu/ib_trading_bot && mkdir -p /home/ubuntu/ib_trading_bot"
          scp -i key.pem -o StrictHostKeyChecking=no -r . ubuntu@${{ secrets.EC2_HOST }}:/home/ubuntu/ib_trading_bot

      - name: Start containers on EC2
        run: |
          ssh -i key.pem -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} "
            set -e
            cd /home/ubuntu/ib_trading_bot

            chmod +x scripts/start_ib.sh scripts/ec2-setup-ib-alias.sh 2>/dev/null || true

            # install CloudWatch Agent if not present
            if [ ! -f /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl ]; then
              cd /tmp
              curl -sS -o amazon-cloudwatch-agent.deb https://s3.amazonaws.com/amazoncloudwatch-agent/ubuntu/amd64/latest/amazon-cloudwatch-agent.deb
              sudo dpkg -i amazon-cloudwatch-agent.deb
              cd /home/ubuntu/ib_trading_bot
            fi

            # update CloudWatch Agent config
            sudo mkdir -p /opt/aws/amazon-cloudwatch-agent/etc
            sudo cp infra/cloudwatch-config.json /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json
            sudo chown root:root /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json

            # start/restart CloudWatch Agent
            sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl \
              -a fetch-config \
              -m ec2 \
              -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json \
              -s

            # remove workflows so Docker doesn't parse them
            rm -rf .github

            # stop old containers
            docker compose -f docker-compose.yml -f docker-compose.ec2.yml down || true

            # start new containers with EC2 override
            docker compose -f docker-compose.yml -f docker-compose.ec2.yml up -d --build --force-recreate
          "

